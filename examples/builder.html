<html>
	<head>
		<script src='../npm/dist/WebAudioFontPlayer.js'></script>
		<script src='https://surikov.github.io/webaudiofontdata/sound/0253_Acoustic_Guitar_sf2_file.js'></script>
		<script>
			var guitar = _tone_0253_Acoustic_Guitar_sf2_file;
			var AudioContextFunc = window.AudioContext || window.webkitAudioContext;
			var audioContext = new AudioContextFunc();
			var output = audioContext.destination;
			var player = new WebAudioFontPlayer();
			var now = 0;

			var C = 0, Cs = 1
				, Db = 1, D = 2, Ds = 3
				, Eb = 3, E = 4
				, F = 5, Fs = 6
				, Gb = 6, G = 7, Gs = 8
				, Ab = 8, A = 9, As = 10
				, Bb = 10, B = 11;
			var O = 12;
			var _6th = E +O*3
				, _5th = A +O*3
				, _4th = D +O*4
				, _3rd = G +O*4
				, _2nd = B +O*4
				, _1st = E +O*5;
			
			var __Am    = {base: A +O*3, strings: [-1, 0, 2, 2, 1, 0]};
			var __Am7   = {base: A +O*3, strings: [-1, 0, 2, 0, 1, 0]};
			var __A7    = {base: A +O*3, strings: [-1, 0, 2, 0, 2, 0]};
			var __A     = {base: A +O*3, strings: [-1, 0, 2, 2, 2, 0]};

			var __Bm7   = {base: B +O*3, strings: [-1, 2, 0, 2, 0, 2]};
			var __B7    = {base: B +O*3, strings: [-1, 2, 1, 2, 0, 2]};

			var __C     = {base: C +O*4, strings: [-1, 3, 2, 0, 1, 0]};
			var __Cmaj7 = {base: C +O*4, strings: [-1, 3, 2, 0, 0, 0]};
			var __C2    = {base: C +O*4, strings: [-1, 3, 2, 0, 3, 0]};

			var __Dm    = {base: D +O*3, strings: [-1,-1, 0, 2, 3, 1]};
			var __D     = {base: D +O*3, strings: [-1,-1, 0, 2, 3, 2]};
			var __D7    = {base: D +O*3, strings: [-1,-1, 0, 2, 3, 2]};
			var __Dsus2 = {base: D +O*3, strings: [-1,-1, 0, 2, 3, 0]};

			var __E     = {base: E +O*3, strings: [ 0, 2, 2, 1, 0, 0]};
			var __Em    = {base: E +O*3, strings: [ 0, 2, 2, 0, 0, 0]};
			var __Em7   = {base: E +O*3, strings: [ 0, 2, 0, 0, 0, 0]};
			var __E7    = {base: E +O*3, strings: [ 0, 2, 0, 1, 0, 0]};

			var __F     = {base: F +O*3, strings: [-1,-1, 3, 2, 1, 1]};
			var __Fmaj7 = {base: F +O*3, strings: [-1,-1, 3, 2, 1, 0]};

			var __G     = {base: G +O*3, strings: [ 3, 2, 0, 0, 0, 3]};

			//var progression8 = [{a:__Am,d:16}, {a:__C,d:16}, {a:__G,d:16}, {a:__Em,d:16}];
			//var progression16 = [{a:__Am,d:16}, {a:__G,d:16}, {a:__F,d:16}, {a:__E,d:16}];
			//var progressionStep=0;
			var progression = new Beats([__Am,16,__C,16,__G,16,__Em,16]);
			
			var tempo = 120;
			
			var _z = 0;
			var _V = 1;
			var _A = 2;
			var _X = 3;
			
			var pattern16 = [{p:_V,d:4},{p:_V,d:2},{p:_A,d:2},{p:_V,d:4},{p:_V,d:2},{p:_A,d:4},{p:_V,d:2},{p:_A,d:4},{p:_V,d:2},{p:_A,d:2},{p:_V,d:4}];
			//var pattern16 = [{p:_V,d:2},{p:_V,d:1},{p:_A,d:1},{p:_V,d:1},{p:_A,d:1},{p:_X,d:2}];
			patternStep=0;
			
			var intervalID=0;
			var nextTickTime = 0;
			var N = 0;
			
			player.loader.decodeAfterLoading(audioContext, '_tone_0253_Acoustic_Guitar_sf2_file');
			function Beats(arr){
				this.steps=[];
				this.duration=0;
				this.step=0;
				for(var i=0;i<arr.length;i=i+2){
					this.steps.push({element:arr[i],duration:arr[i+1]});
					this.duration=this.duration+arr[i+1];
				}
				this.restart=function(){
					this.step=0;
				}
				this.move=function(){
					this.step++;
					if(this.step>this.duration){
						this.step=0;
					}
				}
				this.current=function(){
					//console.log('current',this.steps);
					var delta=0;
					for(var i=0;i<this.steps.length;i++){
						//console.log('delta',delta);
						if(this.step==delta){
							return this.steps[i];
						}
						delta=delta+this.steps[i].duration;
					}
					return null;
				}
				return this;
			}
			function pitches(frets) {
				var p = [];
				if (frets[0] > -1) p.push(_6th + frets[0]);
				if (frets[1] > -1) p.push(_5th + frets[1]);
				if (frets[2] > -1) p.push(_4th + frets[2]);
				if (frets[3] > -1) p.push(_3rd + frets[3]);
				if (frets[4] > -1) p.push(_2nd + frets[4]);
				if (frets[5] > -1) p.push(_1st + frets[5]);
				return p;
			}
			/*function progressionStepAt(n){
				var delta=0;
				for(var i=0;i<progression16.length;i++){
					if(n==delta){
						return progression16[i];
					}
					delta=delta+progression16[i].d;
				}
				return null;
			}*/
			function patternStepAt(n){
				var delta=0;
				for(var i=0;i<pattern16.length;i++){
					if(n==delta){
						return pattern16[i];
					}
					delta=delta+pattern16[i].d;
				}
				return null;
			}
			function tick(){
				if(audioContext.currentTime>nextTickTime-N/8){
					/*var progressionDuration=0;
					for(var i=0;i<progression16.length;i++){
						progressionDuration=progressionDuration+progression16[i].d;
					}*/
					var patternDuration=0;
					for(var i=0;i<pattern16.length;i++){
						patternDuration=patternDuration+pattern16[i].d;
					}
					for(var i=0;i<8;i++){
						//var chord=progressionStepAt(progressionStep);
						//console.log('i',i);
						var chord=progression.current();
						
						if(chord){
							for(var k=0;k<chord.duration;k++){
								var beat=patternStepAt(patternStep);
								if(beat){
									if(beat.p==_V){
										player.queueStrumDown(audioContext, output, guitar
											, nextTickTime+(k+i)*N/16
											, pitches(chord.element.strings), beat.d*N/16);
									}else{
										if(beat.p==_A){
											player.queueStrumUp(audioContext, output, guitar
												, nextTickTime+(k+i)*N/16
												, pitches(chord.element.strings), beat.d*N/16);
										}else{
											if(beat.p==_X){
												player.queueSnap(audioContext, output, guitar
													, nextTickTime+(k+i)*N/16
													, pitches(chord.element.strings), beat.d*N/16);
											}
										}
									}
								}
								patternStep++;
								if(patternStep>=patternDuration){
									patternStep=0;
								}
							}
						}
						progression.move();
						/*progressionStep++;
						if(progressionStep>=progressionDuration){
							progressionStep=0;
						}*/
					}
					nextTickTime = nextTickTime+N/2;
				}
			}
			function cancelPlay(){
				console.log('cancelPlay');
				clearInterval(intervalID);
				player.cancelQueue(audioContext);
			}
			function startPlay(){
				console.log('startPlay');
				cancelPlay();
				audioContext.resume().then(() => {
					console.log('resume');
					});
				ticker4 = 0;				
				N=4*60/tempo;
				console.log(N,tempo);
				nextTickTime = audioContext.currentTime;
				//progressionStep=0;
				progression.restart()
				patternStep=0;
				tick();
				intervalID=setInterval(tick, 33);
			}
			function exportRiff(){
				console.log('exportRiff');
			}
			function randomizeRiff(){
				console.log('randomizeRiff');
			}
		</script>
	</head>
	<body>
		<button onclick='randomizeRiff()'>Randomize</button>
		<button onclick='exportRiff()'>Pianoroll Editor/Export MIDI</button>
		<button onclick='startPlay()'>Play</button>
		<button onclick='cancelPlay()'>Stop</button>
		<hr/>
		<p><a href="https://surikov.github.io/webaudiofont/">source</a></p>
	</body>
</html>