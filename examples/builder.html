<html>
	<head>
		<script src='https://surikov.github.io/webaudiofont/npm/dist/WebAudioFontPlayer.js'></script>
		<script src='https://surikov.github.io/webaudiofontdata/sound/0253_Acoustic_Guitar_sf2_file.js'></script>
		<script src='https://surikov.github.io/webaudiofontdata/sound/0250_Chaos_sf2_file.js'></script>
		<script src='https://surikov.github.io/webaudiofontdata/sound/0340_Aspirin_sf2_file.js'></script>
		
		<script src='https://surikov.github.io/webaudiofontdata/sound/12835_0_Chaos_sf2_file.js'></script>
		<script src='https://surikov.github.io/webaudiofontdata/sound/12838_22_FluidR3_GM_sf2_file.js'></script>
		<script src='https://surikov.github.io/webaudiofontdata/sound/12842_26_JCLive_sf2_file.js'></script>
		<script>
			var guitar = _tone_0253_Acoustic_Guitar_sf2_file;
			//console.log(_tone_0253_Acoustic_Guitar_sf2_file);
			/*for(var i=0;i<_tone_0253_Acoustic_Guitar_sf2_file.zones.length;i++){
				_tone_0253_Acoustic_Guitar_sf2_file.zones[i].originalPitch=_tone_0253_Acoustic_Guitar_sf2_file.zones[i].originalPitch-100;
			}*/
			var drum=_drum_35_0_Chaos_sf2_file;
			var snare=_drum_38_22_FluidR3_GM_sf2_file;
			var hat=_drum_42_26_JCLive_sf2_file;
			var bass=_tone_0340_Aspirin_sf2_file;
			var clean=_tone_0250_Chaos_sf2_file;
			var AudioContextFunc = window.AudioContext || window.webkitAudioContext;
			var audioContext = new AudioContextFunc();
			var output = audioContext.destination;
			var player = new WebAudioFontPlayer();
			var C = 0, Cs = 1
				, Db = 1, D = 2, Ds = 3
				, Eb = 3, E = 4
				, F = 5, Fs = 6
				, Gb = 6, G = 7, Gs = 8
				, Ab = 8, A = 9, As = 10
				, Bb = 10, B = 11;
			var O = 12;
			var _6th = E +O*3
				, _5th = A +O*3
				, _4th = D +O*4
				, _3rd = G +O*4
				, _2nd = B +O*4
				, _1st = E +O*5;
			var frets = [_6th,_5th,_4th,_3rd,_2nd,_1st];

			var __Am    = {base: A +O*3, strings: [-1, 0, 2, 2, 1, 0]};
			var __Am7   = {base: A +O*3, strings: [-1, 0, 2, 0, 1, 0]};
			var __A7    = {base: A +O*3, strings: [-1, 0, 2, 0, 2, 0]};
			var __A     = {base: A +O*3, strings: [-1, 0, 2, 2, 2, 0]};

			var __Bm7   = {base: B +O*3, strings: [-1, 2, 0, 2, 0, 2]};
			var __B7    = {base: B +O*3, strings: [-1, 2, 1, 2, 0, 2]};

			var __C     = {base: C +O*4, strings: [-1, 3, 2, 0, 1, 0]};
			var __Cmaj7 = {base: C +O*4, strings: [-1, 3, 2, 0, 0, 0]};
			var __C2    = {base: C +O*4, strings: [-1, 3, 2, 0, 3, 0]};

			var __Dm    = {base: D +O*3, strings: [-1,-1, 0, 2, 3, 1]};
			var __D     = {base: D +O*3, strings: [-1,-1, 0, 2, 3, 2]};
			var __D7    = {base: D +O*3, strings: [-1,-1, 0, 2, 3, 2]};
			var __Dsus2 = {base: D +O*3, strings: [-1,-1, 0, 2, 3, 0]};

			var __E     = {base: E +O*3, strings: [ 0, 2, 2, 1, 0, 0]};
			var __Em    = {base: E +O*3, strings: [ 0, 2, 2, 0, 0, 0]};
			var __Em7   = {base: E +O*3, strings: [ 0, 2, 0, 0, 0, 0]};
			var __E7    = {base: E +O*3, strings: [ 0, 2, 0, 1, 0, 0]};

			var __F     = {base: F +O*3, strings: [-1,-1, 3, 2, 1, 1]};
			var __Fmaj7 = {base: F +O*3, strings: [-1,-1, 3, 2, 1, 0]};

			var __G     = {base: G +O*3, strings: [ 3, 2, 0, 0, 0, 3]};

			var progressions = [
				new Beats([__Am,8,__C,8,__G,16,__Em,32])
				,new Beats([__Am,16,__C,16,__G,16,__Em,16])
				,new Beats([__Am,8,__C,8,__G,8,__Em,8])
			];
			var progression = progressions[1];
			
			var _z = 0;
			var _V = 1;
			var _A = 2;
			var _X = 3;
			
			var patterns = [
				new Beats([_V,4,_V,2,_A,4,_A,2,_V,2,_A,2])
				,new Beats([_V,4,_V,2,_A,2,_V,4,_A,1,_V,1,_A,2])
				,new Beats([_V,4,_V,2,_A,2,_V,8])
				];
			var pattern=patterns[2];
			
			var arpeggios = [
				new Beats([0,2, -1,2, -2,2, -1,1, -2,1])
				,new Beats([0,2, -3,2, -2,2, -1,2, -2,2, -3,2, -2,2, -1,2])
			];
			var arpeggio = arpeggios[0];
			
			var drumPatterns = [
				new Beats([[drum,hat],2, [hat],2, [snare,hat],2, [hat],2, [drum,hat],2, [drum,hat],2, [snare,hat],2, [hat],1, [hat],1])
			];
			percussions=drumPatterns[0];
			
			var intervalID=0;
			var nextTickTime = 0;
			var N = 0;
			var tempo = 120;
			
			player.loader.decodeAfterLoading(audioContext, '_tone_0253_Acoustic_Guitar_sf2_file');
			player.loader.decodeAfterLoading(audioContext, '_tone_0250_Chaos_sf2_file');
			player.loader.decodeAfterLoading(audioContext, '_tone_0340_Aspirin_sf2_file');
			
			player.loader.decodeAfterLoading(audioContext, '_drum_35_0_Chaos_sf2_file');
			player.loader.decodeAfterLoading(audioContext, '_drum_38_22_FluidR3_GM_sf2_file');
			player.loader.decodeAfterLoading(audioContext, '_drum_42_26_JCLive_sf2_file');
			
			function Beats(arr){
				this.steps=[];
				this.duration=0;
				this.step=0;
				for(var i=0;i<arr.length;i=i+2){
					this.steps.push({element:arr[i],duration:arr[i+1]});
					this.duration=this.duration+arr[i+1];
				};
				this.restart=function(){
					this.step=0;
				};
				this.next=function(){
					var delta=0;
					var s=this.step;
					this.step++;
					if(this.step>=this.duration){
						this.step=0;
					}
					for(var i=0;i<this.steps.length;i++){
						if(s==delta){
							return this.steps[i];
						}
						delta=delta+this.steps[i].duration;
						if(delta>s){
							break;
						}
					}
					return null;
				};
				return this;
			}
			function pitches(frets) {
				var p = [];
				if (frets[0] > -1) p.push(_6th + frets[0]);
				if (frets[1] > -1) p.push(_5th + frets[1]);
				if (frets[2] > -1) p.push(_4th + frets[2]);
				if (frets[3] > -1) p.push(_3rd + frets[3]);
				if (frets[4] > -1) p.push(_2nd + frets[4]);
				if (frets[5] > -1) p.push(_1st + frets[5]);
				return p;
			}
			function patternStepAt(n){
				var delta=0;
				for(var i=0;i<pattern16.length;i++){
					if(n==delta){
						return pattern16[i];
					}
					delta=delta+pattern16[i].d;
				}
				return null;
			}
			function playStrumPattern(chord,at){
				var beat=pattern.next();
				if(beat){
					if(beat.element==_V){
						player.queueStrumDown(audioContext, output, guitar, at, pitches(chord.element.strings), beat.duration*N/16);
					}else{
						if(beat.element==_A){
							player.queueStrumUp(audioContext, output, guitar, at, pitches(chord.element.strings), beat.duration*N/16);
						}else{
							if(beat.element==_X){
								player.queueSnap(audioContext, output, guitar, at, pitches(chord.element.strings), beat.duration*N/16);
							}
						}
					}
				}
			}
			function playArpeggio(chord,at){
				var string=arpeggio.next();
				//console.log(chord,shift,string);
				if(string){
					var pitch=-1;
					//console.log(string.element,chord,chord.element.strings.length);
					if(string.element<0){
						var counter=0;
						for(var i=chord.element.strings.length-1;i>=0;i--){
							if(chord.element.strings[i]>-1){
								counter--;
								if(counter==string.element){
									pitch=frets[i]+chord.element.strings[i];
									break;
								}
							}
						}
					}else{
						var counter=0;
						//console.log('test',string.element,chord.element.strings);
						for(var i=0;i<chord.element.strings.length;i++){
							if(chord.element.strings[i]>-1){
								if(counter==string.element){
									pitch=frets[i]+chord.element.strings[i];
									break;
								}
								counter++;
							}
						}
					}
					
					if(pitch>-1){
						player.queueWaveTable(audioContext, output, clean, at, pitch, string.duration*N/16);
					}
				}
			}
			function playDrums(chord,at){
				var drums=percussions.next();
				if(drums){
					//console.log('drums',drums);
					for(var i=0;i<drums.element.length;i++){
						player.queueWaveTable(audioContext, output, drums.element[i], at, drums.element[i].zones[0].keyRangeLow, 2*N/16,1);
					}
				}
			}
			function tick(){
				//console.log('tick',nextTickTime);
				if(audioContext.currentTime>nextTickTime-N/8){
					//console.log(nextTickTime);
					for(var i=0;i<8;i++){
						var chord=progression.next();
						if(chord){
							//console.log(chord);
							for(var k=0;k<chord.duration;k++){
								//playStrumPattern(chord,nextTickTime+(k+i)*N/16);
								playArpeggio(chord,nextTickTime+(k+i)*N/16);
								//console.log('send',bass, nextTickTime+(k+i)*N/16, chord.base, 2*N/16);
								if((k%2)==0)player.queueWaveTable(audioContext, output, bass, nextTickTime+(k+i)*N/16, chord.element.base-O*1, 2*N/16);
								playDrums(chord,nextTickTime+(k+i)*N/16);
								//if((k%2)==0)player.queueWaveTable(audioContext, output, hat, nextTickTime+(k+i)*N/16, 42, 2*N/16);
								//if((k%8)==0)player.queueWaveTable(audioContext, output, drum, nextTickTime+(k+i)*N/16, 35, 2*N/16,1);
								//if((k%8)==4)player.queueWaveTable(audioContext, output, snare, nextTickTime+(k+i)*N/16, 38, 2*N/16,1);
							}
						}

					}
					nextTickTime = nextTickTime+N/2;
				}
			}
			function cancelPlay(){
				clearInterval(intervalID);
				player.cancelQueue(audioContext);
			}
			function startPlay(){
				cancelPlay();
				ticker4 = 0;
				N=4*60/tempo;
				nextTickTime = audioContext.currentTime;
				progression.restart();
				pattern.restart();
				tick();
				intervalID=setInterval(tick, 33);
				audioContext.resume();
			}
			function exportRiff(){
				console.log('exportRiff');
			}

		</script>
	</head>
	<body>
		<button onclick='randomizeRiff()'>Randomize</button>
		<button onclick='exportRiff()'>Pianoroll Editor/Export MIDI</button>
		<button onclick='startPlay()'>Play</button>
		<button onclick='cancelPlay()'>Stop</button>
		<hr/>
		<p><a href="https://surikov.github.io/webaudiofont/">source</a></p>
	</body>
</html>